<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>{{ page_title }}</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link
      href="https://fonts.googleapis.com/css2?family=Roboto&display=swap"
      rel="stylesheet"
    />
    <script src="https://www.google.com/recaptcha/api.js"></script>
  </head>
  <style>
    * {
      font-family: "Roboto", sans-serif;
    }

    body {
      display: flex;
      justify-content: center;
      align-items: center;
      flex-direction: column;
    }

    .description {
      text-align: center;
      line-height: 1.4em;
      color: #555;
      font-size: 14px;
    }

    .background {
      position: fixed;
      top: 0;
      left: 0;
      height: 100%;
      width: 100%;
      z-index: 0;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32' width='32' height='32' fill='none' stroke='%230f172a' stroke-opacity='0.04'%3E%3Cpath d='M0 .5H31.5V32' /%3E%3C/svg%3E%0A");
      -webkit-mask-image: linear-gradient(
        180deg,
        rgba(255, 255, 255, 1),
        rgba(255, 255, 255, 1),
        rgba(255, 255, 255, 0.3)
      );
      mask-image: linear-gradient(
        180deg,
        rgba(255, 255, 255, 1),
        rgba(255, 255, 255, 1),
        rgba(255, 255, 255, 0.3)
      );
    }

    .fuel-logo {
      display: flex;
      justify-content: center;
      margin-bottom: 20px;
    }

    .button {
      background-color: #04aa6d;
      border: none;
      color: white;
      padding: 16px 32px;
      margin: 4px 2px;
      cursor: pointer;
      border-radius: 10px;
      width: 100%;
      text-transform: uppercase;
      text-decoration: none;
      display: flex;
      box-sizing: border-box;
      text-align: center;
      justify-content: center;
    }

    .button:disabled {
      background-color: gray;
    }

    .card {
      margin-top: 90px;
      z-index: 1;
      width: 480px;
      font-size: 14px;
      padding: 40px 20px 20px 20px;
      border-radius: 10px;
      background-color: white;
      box-shadow: 0 0 16px 2px rgba(248, 248, 248, 0.25);
      border: 1px solid rgb(229, 231, 235);
      max-width: 95%;
    }

    .from-control {
      display: flex;
      flex-direction: column;
    }

    .from-control label {
      margin-bottom: 0.3em;
      color: #333;
    }

    .from-control input {
      border: 1px solid #888;
      border-radius: 4px;
      padding: 10px;
    }
    .from-control input:invalid {
      border: 1px solid red;
    }

    .captcha-container {
      display: flex;
      margin-top: 20px;
      justify-content: center;
    }

    .bold {
      color: #000;
      font-weight: bold;
    }

    .response-title,
    .provider-url,
    #response-failure {
      text-align: center;
    }

    #response-failure {
      color: red;
      padding: 10px;
    }

    #response {
      display: none;
    }

    .provider-url {
      font-size: 12px;
      text-align: center;
      margin-top: 10px;
      color: #949494;
    }

    .queued {
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
      gap: 1rem;
    }

    .loader {
      border: 0.4rem solid #f3f3f3;
      border-top: 0.4rem solid #04aa6d;
      border-radius: 50%;
      width: 2rem;
      height: 2rem;
      animation: spin 2s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .hidden {
      display: none;
    }
  </style>
  <body>
    <div class="background"></div>
    <div class="card">
      <div class="fuel-logo">
        <svg
          xmlns="http://www.w3.org/2000/svg"
          viewBox="0 0 852 852"
          style="width: 80px; height: 80px"
          class="s_logo__16erN"
        >
          <defs></defs>
          <defs>
            <clipPath id="a"><path d="M0 0h852v852H0z"></path></clipPath>
          </defs>
          <g data-name="Fuel logo">
            <g clip-path="url(#a)" data-name="logo">
              <path
                fill="#58c09b"
                d="M638.737 321.745a16.735 16.735 0 0115.33 9.607 17.281 17.281 0 01-1.737 18.127L360.261 715.008a19.368 19.368 0 01-6.229 4.684 16.628 16.628 0 01-15.113-.151 17.057 17.057 0 01-9.192-19.623l52.567-201.191-216.294.664a16.735 16.735 0 01-15.33-9.607c-2.758-5.887-2.056-13.38 1.737-18.127L444.708 106.62a16.178 16.178 0 0120.618-4.793c7.47 3.1 11.376 11.442 9.686 19.394l-52.567 201.19z"
              ></path>
              <path
                fill="none"
                stroke="#58c09b"
                stroke-width="9"
                d="M639.536 328.815c6.585-.071 58.279 27.655 61.04 33.541a17.291 17.291 0 01-1.741 18.129L406.767 746.012a19.366 19.366 0 01-6.23 4.684 16.628 16.628 0 01-15.113-.151c-6.976-3.332-50.131-38.57-47.946-46.751l94.077-152.613H226.679c-6.585.071-71.974-62.843-68.181-67.59q205.349-262.69 293.209-372.414c9.573-11.955 52.922 17.831 60.122 21.654 7.47 3.1 11.376 11.442 9.686 19.394l-52.567 201.19z"
              ></path>
            </g>
          </g>
        </svg>
      </div>
      <form action="javascript:" onsubmit="faucetApp.give_me_coins(this)" id="form">
        <div class="from-control">
          <label for="address">Wallet Address</label>
          <input
            type="text"
            id="address"
            name="address"
            autocomplete="off"
            minlength="63"
            placeholder="fuel100000... or 0x0000..."
            pattern="[a-z0-9]{63,66}"
          />
        </div>
        <p class="description">
          This is a <b class="bold">Test Ether</b> faucet running on the
          <b class="bold">Test Fuel network</b>. This faucet sends fake Ether
          assets to the provided wallet address.
        </p>
        <div class="captcha-container">
          <div
            class="g-recaptcha"
            data-sitekey="6Ld3cEwfAAAAAMd4QTs7aO85LyKGdgj0bFsdBfre"
          ></div>
        </div>
        <div class="queued hidden">
          <div class="loader"></div>
          <div>Waiting until more tokens are available</div>
        </div>
        <br />
        <div id="response-failure"></div>
        <input type="submit" value="Give me Ether" class="button" />
      </form>
      <div id="response">
        <h2 class="response-title">Test Ether sent to the wallet</h2>
        <a href="#" id="explorer-link" class="button">See on Fuel Explorer</a>
      </div>
    </div>
    <div class="provider-url">Node url: {{ public_node_url }}</div>
    <script>
      const faucetApp = (function () {
        let providerUrl = "{{ public_node_url }}";
        let blockExplorer = "https://fuellabs.github.io/block-explorer-v2";
        let query = params = new URLSearchParams(document.location.search);
        let address = query.get('address');

        if (address) {
          let $address = document.getElementById('address');
          if ($address) {
            $address.value = address;
          }
        }

        function showWaiting() {
          document.getElementsByClassName("captcha-container")[0].classList.add("hidden");
          document.getElementsByClassName("queued")[0].classList.remove("hidden");
          form.querySelector("input[type=submit]").disabled = true;
        }

        function hideWaiting() {
          document.getElementsByClassName("captcha-container")[0].classList.remove("hidden");
          document.getElementsByClassName("queued")[0].classList.add("hidden");
          form.querySelector("input[type=submit]").disabled = false;
        }

        function give_me_coins(form) {
          let address = form["address"].value;
          let captcha = form["g-recaptcha-response"].value;
          let xhr = new XMLHttpRequest();
          xhr.open("POST", "/dispense");
          xhr.setRequestHeader("Accept", "application/json");
          xhr.setRequestHeader("Content-Type", "application/json");
          xhr.onload = () =>
            handle_response(address)(JSON.parse(xhr.responseText));
          xhr.onetimeout = () => handle_error("Connection to the server timed out");
          xhr.onerror = () => handle_error("Connection to the server failed");

          let data = {
            address,
            captcha,
          };
          xhr.send(JSON.stringify(data));

          document.getElementById("response-failure").innerText = "";
          showWaiting();
        }
        
        function handle_response(address) {
          return function (data) {
            if (!data.error) {
              document.getElementById("form").hidden = true;
              document.getElementById("response").style.display = "block";
              document.getElementById(
                "explorer-link"
              ).href = `${blockExplorer}/address/${address}?providerUrl=${encodeURIComponent(
                providerUrl
              )}`;
            } else {
              document.getElementById("response-failure").innerText = data.error;
              hideWaiting();
            }
          };
        }

        function handle_error(message) {
          document.getElementById("response-failure").innerText = message;
          hideWaiting();
        }

        return { give_me_coins: give_me_coins };
      })();
    </script>
  </body>
</html>
